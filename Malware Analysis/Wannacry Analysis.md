<br>

# Sample Details
---
Sample Name - <span style="color:#00b0f0">Ransomware.wannacry.exe</span> 
Malware Type- <span style="color:#c00000">Ransomware Cryptoworm</span>
<br>

# Static Analysis
---
### Initial Detonation
Some files start appearing in the desktop.
![[Pasted image 20230806133245.png]]
and all files have been encrypted with a `.WNCRY` extension.
![[Pasted image 20230806133346.png]]
The desktop has a new wallpaper-
![[Pasted image 20230806133525.png]]
And a window opens asking us to pay for decryption.
![[Pasted image 20230806133557.png]]
Now detonating the malware with network simulation.

Immediately we get a dns request for - `www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com`

We get multiple HTTP requests for that domain.
![[Pasted image 20230806134513.png]]
The ransomware doesn't execute.

Now added the domain to hosts file.

		nano C:\Windows\System32\drivers\etc\hosts

![[Pasted image 20230806135040.png]]
We run the malware again.
In wireshark, we notice a lot of ARP requests for a lot of IPs.
![[Pasted image 20230806135330.png]]
After some time , the malware runs-
![[Pasted image 20230806135451.png]]
Maybe the malware is trying to reach out to other devices in the network.
Thus wannacry is a <span style="color:#c00000">ransomware cryptoworm</span>.
<br>

# Static Analysis
---
Generating the strings in the malware-

		Floss.exe -n 6 Ransomware.wannacry.exe

![[Pasted image 20230806140457.png]]
Interesting strings -

```
taskdl.exe
taskse.exe
u.wnry

<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
  <trustInfo xmlns="urn:schemas-microsoft-com:asm.v2">
    <security>
      <requestedPrivileges>
        <requestedExecutionLevel level="asInvoker" />
      </requestedPrivileges>
    </security>
  </trustInfo>
  <dependency>
    <dependentAssembly>
        <assemblyIdentity
            type="win32"
            name="Microsoft.Windows.Common-Controls"
            version="6.0.0.0"
            processorArchitecture="*"
            publicKeyToken="6595b64144ccf1df"
            language="*"
        />
    </dependentAssembly>
  </dependency>
  <compatibility xmlns="urn:schemas-microsoft-com:compatibility.v1">
    <application> 
       <!-- Windows 10 --> 
       <supportedOS Id="{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}"/>
       <!-- Windows 8.1 -->
       <supportedOS Id="{1f676c76-80e1-4239-95bb-83d0f6d0da78}"/>
       <!-- Windows Vista -->
       <supportedOS Id="{e2011457-1546-43c5-a5fe-008deee3d3f0}"/> 
       <!-- Windows 7 -->
       <supportedOS Id="{35138b9a-5d96-4fbd-8e2d-a2440225f93a}"/>
       <!-- Windows 8 -->
       <supportedOS Id="{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}"/>
    </application> 
  </compatibility>
</assembly>

%s -m security
C:\%s\qeriuwjhrf
tasksche.exe
icacls . /grant Everyone:F /T /C /Q
WNcry@2ol7
```
We got some file names ,xml file and UNC paths that call to remote shares.

Now we open the malware in <span style="color:#ffff00">PEview</span>.
![[Pasted image 20230806142942.png]]
![[Pasted image 20230806143006.png]]
The sizes of virtual size and pointer to raw data don't add up. So this malware may be packed.
We also see some IAT imports-
![[Pasted image 20230806143138.png]]
Interesting imports-
```
- CryptGetRandom
- CryptAcquireContextA
- InternetOpenA
- InternetOpenUrl
- CreateServiceA
- ChangeServiceConfig2A
```

Now opening the file in <span style="color:#ffff00">PEstudio</span>.
![[Pasted image 20230806143246.png]]
The malware is written in <span style="color:#047c3a">C++</span> and is compiled for <span style="color:#047c3a">32 bit windows systems</span>.
<br>

# Dynamic Analysis
---
Adding a filter on procmon and monitoring tcpview before malware is run.
![[Pasted image 20230806144502.png]]
![[Pasted image 20230806144510.png]]
We see that the malware is trying to reachout to other devices.Also weirdly it makes a connection on port UDP:1919 using the process <span style="color:#7030a0">svchost.exe</span> .
The malware is definitely trying to infect other devices in the network.

Also a list of processes have opened up on procmon-
![[Pasted image 20230806144803.png]]
Adding another filter to procmon using the strings output-
![[Pasted image 20230806145040.png]]
Nothingcomes up-
![[Pasted image 20230806145112.png]]
![[Pasted image 20230806145727.png]]
We get  some results-
![[Pasted image 20230806145751.png]]
A file is created at -`C:\Windows\tasksche.exe`
![[Pasted image 20230806145913.png]]
There is also some registry activity-
![[Pasted image 20230806150008.png]]
A service must be created to make this exe file persistent.
A hidden foldehas been created in `C:\ProgramData`
![[Pasted image 20230806150314.png]]
It contains files from initial detonation of the malware.
![[Pasted image 20230806150347.png]]
Now opening the file in cutter to locate the killswitch mechanism.

![[Pasted image 20230806150517.png]]
![[Pasted image 20230806150654.png]]
```
Q: Use Cutter to locate the killswitch mechanism in the decompiled code and explain how it functions.

A: The killswitch operates like this:

- In the main function of WannaCry, the string of the killswitch URL is moved into ECX.
- The arguments for InternetOpenA are pushed onto the stack. The boolean result of InternetOpenA is moved into EAX.
- The arguments for InternetOpenUrlA are pushed onto the stack, including the killswitch URL. The result of InternetOpenUrlA is moved into EAX. Then, this result is also moved into EDI.
- The handle is closed and the program compares the value of EDI to 0 (comparing a boolean true or false).
- If the value is 0, WannaCry makes a call to the first function in the payload.
- Else, WannaCry exits without triggering the payload.
```
