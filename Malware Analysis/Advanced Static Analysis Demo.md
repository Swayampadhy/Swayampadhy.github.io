<br>

# Sample Information
-----
Name - <span style="color:#00b0f0">Malware.stage0.exe</span> --> <span style="color:#00b0f0">werflt.exe</span>
Type - <span style="color:#c00000">Process Injector</span>
<br>

# Analysis
-----
Tools used - <span style="color:#ffff00">cutter</span>

![[Pasted image 20230729004017.png]]
We notice that the malware is a portable executable for x86 architecture and is written in c.

It imports three libraries-
```
kernel32.dll
msvcrt.dll
user32.dll
```

Exiting this pe, and running the malware ,we see that it creates another exe file named `werflt.exe` and injects a reverse shell into the legitimate process `werfault.exe`. We take the created binary and run it in cutter.
![[Pasted image 20230729013915.png]]

We run the disassembly in graph mode and get the disassembled main function.

![[Pasted image 20230729014120.png]]

And the decompiled main function-->

![[Pasted image 20230729014300.png]]
We can see process injection is taking place. This is a very common tactic employed by malware authors to avoid detection. The malware code injects itself into a legitimate process and runs as if it was part of the program in the first place. Fortunately this <span style="color:#047c3a">create remote thread process</span> is being caught by defenders more easily now-a-days.

Now onto analysis of the assembly code,

![[Pasted image 20230729015248.png]]
We see that an argument is being passed onto the main program . Furthermore it is being transferred to `EAX` from a memory location - `lpStartAddress` .

Moving on we see an API call for `OpenProcess` -
![[Pasted image 20230729015724.png]]
The argument in `EAX` is being passed onto the API as a <span style="color:#047c3a">DWORD</span> argument.This API call would give complete access over the process which is provided as the argument.

We see more API calls below-
![[Pasted image 20230729015910.png]]

We see that the value in `eax` is being moved to `edi` which means we are giving the pid of the process used above to <span style="color:#047c3a">VirtualAllocEx</span> API and allocating some amount of memory in it.

![[Pasted image 20230729015932.png]]

This API provides a <span style="color:#047c3a">buffer</span> for the process.

![[Pasted image 20230729020007.png]]

Two arguments are being passed onto the <span style="color:#047c3a">CreateRemoteThread</span> API - `ESI` and `EDI`. It will execute the data contents on `ESI` . Now as `ESI` contains the process address, this API will create a thread inside that remote process.

And Finally-
![[Pasted image 20230729020030.png]]
To close the process and thread.
So it seems that -
The malware is creating a process using the argument name--> allocating memory for the malicious code-->creating a buffer for the process-->creating a thread to run the reverse shell-->closing the handle and terminating the process.


