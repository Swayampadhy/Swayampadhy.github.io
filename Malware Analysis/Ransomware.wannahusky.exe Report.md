Malware type- <span style="color:#c00000">Ransomware</span>
<br>

# Static Analysis
---
Strings-

		Floss.exe -n 6 .\Ransomware.wannahusky.exe.malz > strings.txt

![[Pasted image 20230807122225.png]]

Interesting strings-

```
@tree C:\
@Desktop\ps1.ps1
@powershell 
@Desktop\ps1.ps1
$wallpaper = ".\WANNAHUSKY.PNG"
@Desktop\WANNAHUSKY.png
@Desktop\cosmo.WANNAHUSKY
@bcmode.nim(503, 9) `len(input) <= len(output)` 
@COSMO
@Desktop\target\cosmo.WANNAHUSKY
@Desktop\cosmo.jpeg
pseudo-reloc-list.c
streams.nim
@mwannahusky.nim.c_asgnRef0
```
The `streams.nim` strings shows that the malware is written in nim.
Now opening the file using <span style="color:#ffff00">peview</span>.
![[Pasted image 20230807123448.png]]
The file is a portable windows executable.
![[Pasted image 20230807123526.png]]
The malware is a packed malware as values of virtual size and size of raw data don't match.Lack of imports confirm this-->
![[Pasted image 20230807123700.png]]
Now opening in <span style="color:#ffff00">pestudio</span>.
![[Pasted image 20230807123826.png]]
The malware runs in the console subsystem.
![[Pasted image 20230807172817.png]]
![[Pasted image 20230807172836.png]]
Now opening the malware in <span style="color:#ffff00">cutter</span> for further analysis.
![[Pasted image 20230807191234.png]]
Above is the main function of the malware.
![[Pasted image 20230807203828.png]]
Cutter is showing that the malware is written in c even though we see some nim imports.Maybe the initial payload is written in c and the inner payload is written in nim. Moving onto Dynamic Analysis.
<br>

# Dynamic Analysis
----
### Initial detonation

Without Network-
![[Pasted image 20230807204125.png]]
A console pops up with some output. Most probably showing the output of `tree` command.
![[Pasted image 20230807204351.png]]
We see that a file has been created and the cosmo.jpeg folder has been encrypted with the extension of `.WANNAHUSKY` 

Contents of the file-
![[Pasted image 20230807204501.png]]
Reverting and now running with network on.

With Network-
The malware runs the same and there is no impact on the network.

Now we open <span style="color:#ffff00">tcpview</span> to see if the malware makes any internal connections.
![[Pasted image 20230807211200.png]]
Nothing so far. Now moving onto <span style="color:#ffff00">procmon</span>-
![[Pasted image 20230807211331.png]]
Then run the malware-
![[Pasted image 20230807214545.png]]
There are three processes hidden underneath. One is the tree function we saw earlier.
Second is a powershell process running `ps1.ps1` file from the desktop.
Third is a `conhost.exe` process keeping the console host alive.
The powershell file exits almost immediately.
![[Pasted image 20230807214931.png]]
Running the malware fast enough and clicking the cmd window gives us our 
`ps1.ps1` file.
![[Pasted image 20230807215635.png]]

Contents of ps1.ps1 file-
![[Pasted image 20230807215801.png]]
This ps1 script is trying to make the created png file as the desktop wallpaper. But that didn't happen. So something must've gone wrong.

Yara rules-
```
rule wannahusky_ransomware {  
  
meta:  
last_updated = "2023-03-23"  
author = "finx"  
description = "YARA rule to detect Wannahusky Ransomware"  
  
strings:  
// Fill out identifying strings and other criteria  
$PE_magic_byte = "MZ"  
$string1 = "nim" ascii  
$string2 = "WANNAHUSKY.png" ascii  
$string3 = "cosmo.WANNAHUSKY" ascii  
$string4 = "ps1.ps1" ascii  
  
condition:  
// Fill out the conditions that must be met to identify the binary  
$PE_magic_byte at 0 and  
all of them  
  
}
```
<br>

# Conclusion
----
The malware first starts the `ps1.ps1` file and deletes it immediately. The file was supposed change the wallpaper but fails to do so. Then a cmd shows up running `tree` . Finally the malware encrypts the `cosmo.jpeg` file to `cosmo.WANNAHUSKY` and exits out of the program creating a png file that threatens the user to pay up.
 



